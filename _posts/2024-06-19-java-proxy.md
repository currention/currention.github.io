---
title: Java 代理
date: 2024-06-19 22:00:00 +0800
categories: [Java]
tags: [Java, Base]
---


## 静态代理



## 动态代理

动态代理是 Java 中的一种代理模式，它可以在运行时动态地创建代理对象，而不需要提前定义代理类。动态代理通常用于实现 AOP（面向切面编程）。

在 Java 中，动态代理可以通过以下三种方式实现：JDK 动态代理、CGLIB 动态代理和 javassist 动态代理。

### JDK 动态代理

JDK 动态代理是 Java 提供的一种动态代理机制，它可以在运行时动态地创建代理对象。JDK 动态代理要求被代理的类必须实现一个或多个接口。

JDK 动态代理的实现步骤如下：

1. 创建一个实现了 InvocationHandler 接口的类，该类负责实现代理对象的方法调用逻辑。
2. 创建一个被代理的类，该类必须实现一个或多个接口。
3. 使用 Proxy 类的 newProxyInstance 方法创建代理对象，该方法需要传入被代理类的 Class 对象、实现了 InvocationHandler 接口的类的实例以及被代理类实现的接口数组。

### CGLIB 动态代理

CGLIB 动态代理是第三方库 CGLIB 提供的一种动态代理机制，它可以在运行时动态地创建代理对象。CGLIB 动态代理不需要被代理的类实现接口，而是通过生成被代理类的子类来实现代理。

CGLIB 动态代理的实现步骤如下：

1. 创建一个实现了 MethodInterceptor 接口的类，该类负责实现代理对象的方法调用逻辑。
2. 创建一个被代理的类。
3. 使用 CGLIB 的 Enhancer 类的 create 方法创建代理对象，该方法需要传入被代理类的 Class 对象、实现了 MethodInterceptor 接口的类的实例以及被代理类的 Class 对象。

### javassist 动态代理

javassist 动态代理是第三方库 javassist 提供的一种动态代理机制，它可以在运行时动态地创建代理对象。javassist 动态代理不需要被代理的类实现接口，而是通过修改被代理类的字节码来实现代理。

javassist 动态代理的实现步骤如下：

1. 创建一个实现了 MethodHandler 接口的类，该类负责实现代理对象的方法调用逻辑。
2. 创建一个被代理的类。
3. 使用 javassist 的 ProxyFactory 类的 create 方法创建代理对象，该方法需要传入被代理类的 Class 对象、实现了 MethodHandler 接口的类的实例以及被代理类的 Class 对象。

### ByteBuddy 动态代理

ByteBuddy 是一个 Java 库，它可以在运行时动态地创建代理对象。ByteBuddy 动态代理不需要被代理的类实现接口，而是通过修改被代理类的字节码来实现代理。

ByteBuddy 动态代理的实现步骤如下：

1. 创建一个实现了 MethodHandler 接口的类，该类负责实现代理对象的方法调用逻辑。
2. 创建一个被代理的类。

## 代理模式的应用场景

代理模式是一种常用的设计模式，它可以在不改变原有对象的情况下，通过引入代理对象来扩展原有对象的功能。代理模式的应用场景包括但不限于以下几个方面：

1. 远程代理：在分布式系统中，可以通过代理对象来访问远程对象，从而实现远程调用。
2. 虚拟代理：在创建开销较大的对象时，可以通过代理对象来延迟对象的创建，从而提高系统的性能。
3. 保护代理：在访问受保护的资源时，可以通过代理对象来控制访问权限，从而保护资源的访问安全。
4. 缓存代理：在需要频繁访问相同的数据时，可以通过代理对象来缓存数据，从而提高系统的性能。
5. 防火墙代理：在需要过滤网络请求时，可以通过代理对象来过滤请求，从而保护内部网络的安全。
6. 日志代理：在需要记录方法调用的日志时，可以通过代理对象来记录日志，从而方便后续的调试和分析。
7. 延迟加载：在需要延迟加载对象时，可以通过代理对象来延迟对象的加载，从而提高系统的性能。
8. 动态代理：在需要动态地创建代理对象时，可以通过代理模式来实现动态代理，从而实现更加灵活的代码结构。
9. AOP（面向切面编程）：在需要将横切关注点（如日志、事务、安全等）与业务逻辑分离时，可以通过代理模式来实现 AOP，从而提高代码的可维护性和可扩展性。


## 动态代理的应用示例

### Spring AOP

Spring AOP 是 Spring 框架中的一种面向切面编程（AOP）的实现方式，它通过动态代理来实现切面的织入。Spring AOP 支持两种代理方式：JDK 动态代理和 CGLIB 动态代理。JDK 动态代理要求被代理的类实现接口，而 CGLIB 动态代理则不需要被代理的类实现接口。

### MyBatis

MyBatis 是一个持久层框架，它通过动态代理来实现 SQL 语句的执行。MyBatis 中使用了 JDK 动态代理、CGLIB、 javassist ，默认Mapper代理使用的是JDK动态代理，如果要使用CGLIB 可以在配置文件中指定。而懒加载是通过javassist实现的。

### Dubbo

Dubbo 是一个分布式服务框架，它通过动态代理来实现远程调用的代理。Dubbo 的动态代理是通过 JDK 动态代理和 CGLIB 动态代理实现的，它要求被代理的类实现接口或者不实现接口。默认使用 javassist 动态字节码生成，也可以通过 SPI 扩展机制配置自己的动态代理策略。
